#!/usr/bin/env sh

current_branch=$(git symbolic-ref --short HEAD)
merge_branch=merge/$(date +"%Y%m%d")

log() {
    echo "ğŸ¤– "$@
}

if ! git ls-remote --heads --tags origin | grep -q "$merge_branch"
then
    log "å½“å‰: \"$current_branch\""

    week=$(date +"%u")

    if [ "$week" = "1" ]
    then
        from=master
    else
        from=merge/$(gdate --date="yesterday" +"%Y%m%d")
        if ! git show-ref --quiet refs/heads/$from
        then
            from=master
        fi
    fi

    log "ä» \"$from\" åˆ›å»º: \"$merge_branch\""
    git checkout $from
    git checkout -b $merge_branch

    log "æ¨é€: \"$merge_branch\""
    git push --set-upstream origin $merge_branch --no-verify

    log "åˆ‡æ¢å›: \"$current_branch\"!"
    git checkout $current_branch
else
    log "å·²å­˜åœ¨ \"$merge_branch\""
    git checkout $merge_branch
fi
